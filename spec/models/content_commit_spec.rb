require "rails_helper"

RSpec.describe ContentCommit, type: :model do
  describe "factory" do
    let(:content_commit) { FactoryBot.create(:content_commit) }
    let(:committed_at) { Time.at(1605753499) }
    it "is valid" do
      expect(content_commit).to be_valid
      expect(content_commit.committed_at).to be_within(1).of committed_at
      expect(content_commit.reconciler_update?).to be_falsey
      expect(content_commit.author).to eq "sethherr"
    end
  end

  describe "reconciler_update?" do
    let(:github_json) { '{"sha":"df11e5b3abc02939becc893861bf9934a96b8f59","node_id":"MDY6Q29tbWl0Mjk1ODQzNjEwOmRmMTFlNWIzYWJjMDI5MzliZWNjODkzODYxYmY5OTM0YTk2YjhmNTk=","commit":{"author":{"name":"convus-admin-bot","email":"admin-bot@convus.org","date":"2020-11-13T16:33:26.000Z"},"committer":{"name":"convus-admin-bot","email":"admin-bot@convus.org","date":"2020-11-13T16:33:26.000Z"},"message":"Reconciliation: 2020-11-13","tree":{"sha":"6ecc55471d60c1b5384cc1376b9051b46234ce75","url":"https://api.github.com/repos/convus/convus_content/git/trees/6ecc55471d60c1b5384cc1376b9051b46234ce75"},"url":"https://api.github.com/repos/convus/convus_content/git/commits/df11e5b3abc02939becc893861bf9934a96b8f59","comment_count":0,"verification":{"verified":false,"reason":"unsigned","signature":null,"payload":null}},"url":"https://api.github.com/repos/convus/convus_content/commits/df11e5b3abc02939becc893861bf9934a96b8f59","html_url":"https://github.com/convus/convus_content/commit/df11e5b3abc02939becc893861bf9934a96b8f59","comments_url":"https://api.github.com/repos/convus/convus_content/commits/df11e5b3abc02939becc893861bf9934a96b8f59/comments","author":{"login":"convus-admin-bot","id":71787816,"node_id":"MDQ6VXNlcjcxNzg3ODE2","avatar_url":"https://avatars1.githubusercontent.com/u/71787816?v=4","gravatar_id":"","url":"https://api.github.com/users/convus-admin-bot","html_url":"https://github.com/convus-admin-bot","followers_url":"https://api.github.com/users/convus-admin-bot/followers","following_url":"https://api.github.com/users/convus-admin-bot/following{/other_user}","gists_url":"https://api.github.com/users/convus-admin-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/convus-admin-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/convus-admin-bot/subscriptions","organizations_url":"https://api.github.com/users/convus-admin-bot/orgs","repos_url":"https://api.github.com/users/convus-admin-bot/repos","events_url":"https://api.github.com/users/convus-admin-bot/events{/privacy}","received_events_url":"https://api.github.com/users/convus-admin-bot/received_events","type":"User","site_admin":false},"committer":{"login":"convus-admin-bot","id":71787816,"node_id":"MDQ6VXNlcjcxNzg3ODE2","avatar_url":"https://avatars1.githubusercontent.com/u/71787816?v=4","gravatar_id":"","url":"https://api.github.com/users/convus-admin-bot","html_url":"https://github.com/convus-admin-bot","followers_url":"https://api.github.com/users/convus-admin-bot/followers","following_url":"https://api.github.com/users/convus-admin-bot/following{/other_user}","gists_url":"https://api.github.com/users/convus-admin-bot/gists{/gist_id}","starred_url":"https://api.github.com/users/convus-admin-bot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/convus-admin-bot/subscriptions","organizations_url":"https://api.github.com/users/convus-admin-bot/orgs","repos_url":"https://api.github.com/users/convus-admin-bot/repos","events_url":"https://api.github.com/users/convus-admin-bot/events{/privacy}","received_events_url":"https://api.github.com/users/convus-admin-bot/received_events","type":"User","site_admin":false},"parents":[{"sha":"d2015248d0ed910dd5533ed14f2020daf15d931a","url":"https://api.github.com/repos/convus/convus_content/commits/d2015248d0ed910dd5533ed14f2020daf15d931a","html_url":"https://github.com/convus/convus_content/commit/d2015248d0ed910dd5533ed14f2020daf15d931a"}],"stats":{"total":6,"additions":4,"deletions":2},"files":[{"sha":"2be835d0094793f5a1de140801272fc19b110ea0","filename":"hypotheses/publications-that-charge-to-publish-articles-and-don-t-have-peer-review-or-issue-retractions-are-the-least-reputable-source-for-information.yml","status":"renamed","additions":3,"deletions":2,"changes":5,"blob_url":"https://github.com/convus/convus_content/blob/df11e5b3abc02939becc893861bf9934a96b8f59/hypotheses/publications-that-charge-to-publish-articles-and-don-t-have-peer-review-or-issue-retractions-are-the-least-reputable-source-for-information.yml","raw_url":"https://github.com/convus/convus_content/raw/df11e5b3abc02939becc893861bf9934a96b8f59/hypotheses/publications-that-charge-to-publish-articles-and-don-t-have-peer-review-or-issue-retractions-are-the-least-reputable-source-for-information.yml","contents_url":"https://api.github.com/repos/convus/convus_content/contents/hypotheses/publications-that-charge-to-publish-articles-and-don-t-have-peer-review-or-issue-retractions-are-the-least-reputable-source-for-information.yml?ref=df11e5b3abc02939becc893861bf9934a96b8f59","patch":"@@ -1,5 +1,6 @@\n ---\n-title: Publications that charge to publish articles, and don\'t have peer review or issue retractions, are the least reputable source for information.\n+title: Publications that charge to publish articles, and don\'t have peer review or\n+  issue retractions, are the least reputable source for information.\n id: 2248\n cited_urls:\n - url: https://beallslist.net\n@@ -13,7 +14,7 @@ cited_urls:\n   - \'The difference—editing and peer review—is critical: when it comes to public health,\n     fake journals are a real danger.\'\n topics:\n-- Scholarly Journals\n - Peer review\n - Publishing\n+- Scholarly Journals\n - Science","previous_filename":"hypotheses/journals-that-do-not-practice-peer-review-are-not-scholarly-and-can-be-hard-to-differentiate-from-journals-which-do.yml"},{"sha":"86af230a60a66bdd418ce4f85ee06290f3815639","filename":"tags.csv","status":"modified","additions":1,"deletions":0,"changes":1,"blob_url":"https://github.com/convus/convus_content/blob/df11e5b3abc02939becc893861bf9934a96b8f59/tags.csv","raw_url":"https://github.com/convus/convus_content/raw/df11e5b3abc02939becc893861bf9934a96b8f59/tags.csv","contents_url":"https://api.github.com/repos/convus/convus_content/contents/tags.csv?ref=df11e5b3abc02939becc893861bf9934a96b8f59","patch":"@@ -64,6 +64,7 @@ Public assistance programs,86,\n Publishing,96,\n Race,75,\n Religion \u0026 Spirituality,3,family_rank\n+Scholarly Journals,98,\n Science,94,\n Sex,23,\n Sexuality,33,"}]}' }
    let(:github_data) { JSON.parse(github_json) }
    let(:content_commit) { ContentCommit.create(github_data: github_data) }
    it "is truthy" do
      expect(content_commit.sha).to eq "df11e5b3abc02939becc893861bf9934a96b8f59"
      expect(content_commit.reconciler_update?).to be_truthy
    end
  end
end
